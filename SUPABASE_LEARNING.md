# Supabase 학습 가이드 & 작업 리포트 (Level 1)

## 1. 현재 상태 점검 결과
✅ **모든 연결 성공!**
- **서울시 데이터**: 성공적으로 연결됨 (일별 데이터 수집 가능)
- **기상청 API**: 성공적으로 연결됨
- **Supabase**: 테이블이 생성되었고, Python에서 데이터를 읽고 쓸 수 있는 권한이 확인되었습니다.

---

## 2. 우리가 Supabase로 한 작업들 (상세 코드 포함)

이번 과정에서 우리는 **로컬 파일(CSV/JSON)** 중심의 데이터 저장 방식을 **클라우드 데이터베이스(Supabase PostgreSQL)**로 성공적으로 전환했습니다.

### 1단계: 인증 (API Key) & 환경 설정
- **문제**: API Key를 코드에 직접 적으면 보안 사고가 발생합니다.
- **해결**: `.env` 파일을 사용하여 키를 분리했습니다.
  
  ```bash
  # .env 파일 예시
  SUPABASE_URL=https://your-project-id.supabase.co
  SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  ```
  
  ```python
  # Python에서 불러오기
  import os
  from dotenv import load_dotenv
  
  load_dotenv()
  url = os.getenv("SUPABASE_URL")
  key = os.getenv("SUPABASE_KEY")
  ```

### 2단계: 스키마 설계 (SQL)
Supabase의 SQL Editor에서 아래 코드를 실행하여 두 개의 테이블을 만들었습니다.

#### 테이블 1: 지하철 승하차 인원 (`subway_traffic`)
```sql
create table if not exists subway_traffic (
  id bigint generated by default as identity primary key,
  date date not null,
  station_name text not null,       -- 예: '성수'
  line_number text not null,        -- 예: '2호선'
  boarding_count int,               -- 승차 인원
  alighting_count int,              -- 하차 인원
  created_at timestamp with time zone default timezone('utc'::text, now()),
  
  -- 중복 데이터 방지 (같은 날짜, 같은 역, 같은 호선은 유일해야 함)
  unique(date, station_name, line_number)
);
```

#### 테이블 2: 날씨 데이터 (`weather_data`)
```sql
create table if not exists weather_data (
  id bigint generated by default as identity primary key,
  measured_at timestamp with time zone not null, -- 측정 시간
  temperature float,                             -- 기온
  precipitation_type int,                        -- 강수 형태 (0: 없음, 1: 비, etc)
  humidity float,                                -- 습도
  created_at timestamp with time zone default timezone('utc'::text, now())
);
```

### 3단계: 파이썬 연동 (`storage_supabase.py`)
`supabase-py` 라이브러리를 사용해 데이터를 저장하는 핵심 로직입니다.

```python
from supabase import create_client

class SupabaseStorage:
    def __init__(self):
        self.client = create_client(os.getenv("SUPABASE_URL"), os.getenv("SUPABASE_KEY"))

    def save_subway_data(self, data):
        """
        데이터를 'Upsert' 합니다. 
        Upsert란? 이미 있는 데이터(날짜+역)면 업데이트하고, 없으면 새로 넣는 방식입니다.
        """
        # 데이터 포맷을 DB 컬럼명에 맞게 변환
        formatted_data = [
            {
                "date": row['USE_DT'],          # YYYYMMDD
                "station_name": row['SUB_STA_NM'],
                "line_number": row['LINE_NUM'],
                "boarding_count": int(row['RIDE_PASGR_NUM']),
                "alighting_count": int(row['ALIGHT_PASGR_NUM'])
            }
            for row in data
        ]
        
        # Supabase에 전송
        self.client.table("subway_traffic").upsert(
            formatted_data, 
            on_conflict="date, station_name, line_number"
        ).execute()
```

---

## 3. 핵심 개념 요약

1.  **PostgreSQL**: Supabase가 사용하는 세계에서 가장 진보된 오픈소스 관계형 데이터베이스입니다.
2.  **Upsert (Insert + Update)**: 데이터 중복을 막기 위한 가장 좋은 방법입니다. "있으면 덮어쓰고, 없으면 넣어라"라는 명령입니다.
3.  **Client-Side Library (`supabase-py`)**: SQL을 직접 짜지 않아도 함수(`insert`, `select`)로 DB를 조작하게 해줍니다.

---

## 4. 다음 단계

이제 인프라가 갖춰졌으니, 실제로 주기적으로 데이터를 쌓고(Level 1 완료), 이 데이터를 꺼내서 분석(Level 2)하는 단계로 넘어갑니다.
