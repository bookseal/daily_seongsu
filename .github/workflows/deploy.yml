name: Deploy to Production

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # CI Pipeline(ci.yml)ì´ ì„±ê³µí•´ì•¼ë§Œ ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
    # ì£¼ì˜: ì´ ì´ë¦„ì€ ci.ymlì˜ job ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
    # needs: lint-and-test 
    # (ì°¸ê³ : ë³„ë„ íŒŒì¼ì˜ jobì„ needsë¡œ ê±¸ë ¤ë©´ workflow_runì„ ì¨ì•¼ í•˜ì§€ë§Œ, 
    #  ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ì—¬ê¸°ì„œëŠ” ë…ë¦½ ì‹¤í–‰í•˜ê±°ë‚˜, ci.ymlì„ í•©ì¹˜ëŠ”ê²Œ ì¢‹ìŠµë‹ˆë‹¤.
    #  í•˜ì§€ë§Œ GitHub ActionsëŠ” íŒŒì¼ ê°„ ì¢…ì†ì„±ì„ ì§ì ‘ 'needs'ë¡œ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    #  ëŒ€ì‹  'workflow_run'ì„ ì“°ê±°ë‚˜, ci.yml ì•ˆì— deploy jobì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.)
    #  
    #  ì§€ê¸ˆì€ ë¶„ë¦¬ëœ íŒŒì¼ì´ë¯€ë¡œ 'needs'ë¥¼ ì œê±°í•˜ê³  ë…ë¦½ì ìœ¼ë¡œ ëŒê±°ë‚˜,
    #  workflow_runì„ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.

    steps:
      - name: Deploy to OCI Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸš€ Starting Deployment..."
            
            # 1. Project Directory ì´ë™
            cd /home/ubuntu/workspace/daily_seongsu
            
            # 2. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin main
            
            # 3. Docker Rebuild & Restart
            # OCI A1(ARM64) ì„œë²„ì—ì„œ ì§ì ‘ ë¹Œë“œí•˜ì—¬ ì•„í‚¤í…ì²˜ í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°
            docker compose down
            docker compose up -d --build
            
            # 4. Cleanup
            docker image prune -f
            
            echo "âœ… Deployment Successful!"
