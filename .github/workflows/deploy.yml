name: Deploy to Production

on:
  # CI ì›Œí¬í”Œë¡œìš°ê°€ main ë¸Œëœì¹˜ì—ì„œ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ í›„ì—ë§Œ ì‹¤í–‰
  workflow_run:
    workflows: ["Daily Seongsu CI"]
    types: [completed]
    branches: [main]
  # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # workflow_run: CI ì„±ê³µ ì‹œë§Œ / workflow_dispatch: ìˆ˜ë™ ì‹¤í–‰ ì‹œ ë¬´ì¡°ê±´
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy to OCI Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "ğŸš€ Starting Deployment..."

            cd /home/ubuntu/workspace/daily_seongsu

            # 1. ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ í™•ì¸ (git pull ì „)
            git fetch origin main
            CHANGED=$(git diff HEAD origin/main --name-only)
            echo "ğŸ“‹ Changed files:"
            echo "$CHANGED"

            # 2. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin main

            # 3. ë°°í¬ ë°©ì‹ ìë™ íŒë‹¨
            # requirements.txt ë˜ëŠ” Dockerfileì´ ë°”ë€Œë©´ â†’ ì´ë¯¸ì§€ ì¬ë¹Œë“œ (ëŠë¦¼, ~5ë¶„)
            # ì½”ë“œ(.py)ë§Œ ë°”ë€Œë©´ â†’ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ë§Œ (ë¹ ë¦„, ~30ì´ˆ)
            if echo "$CHANGED" | grep -qE "requirements.txt|Dockerfile|docker-compose.yml"; then
              echo "ğŸ“¦ Dependency change detected â†’ Full rebuild..."
              docker compose up -d --build
              docker image prune -f
            else
              echo "ğŸ”„ Code-only change â†’ Fast restart..."
              docker restart daily-seongsu-container
            fi

            echo "âœ… Deployment Successful!"
