name: Deploy to Production

on:
  # CI ì›Œí¬í”Œë¡œìš°ê°€ main ë¸Œëžœì¹˜ì—ì„œ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œëœ í›„ì—ë§Œ ì‹¤í–‰
  workflow_run:
    workflows: ["Daily Seongsu CI"]
    types: [completed]
    branches: [main]
  # GitHub UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # workflow_run: CI ì„±ê³µ ì‹œë§Œ / workflow_dispatch: ìˆ˜ë™ ì‹¤í–‰ ì‹œ ë¬´ì¡°ê±´
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Setup SSH key from base64 secret
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to OCI Server via SSH
        run: |
          ssh -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            echo "ðŸš€ Starting Deployment..."

            cd /home/ubuntu/workspace/daily_seongsu

            # 1. ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ í™•ì¸ (git pull ì „)
            git fetch origin main
            CHANGED=$(git diff HEAD origin/main --name-only)
            echo "ðŸ“‹ Changed files:"
            echo "$CHANGED"

            # 2. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin main

            # 3. ë°°í¬ ë°©ì‹ ìžë™ íŒë‹¨
            # requirements.txt ë˜ëŠ” Dockerfileì´ ë°”ë€Œë©´ â†’ ì´ë¯¸ì§€ ìž¬ë¹Œë“œ (ëŠë¦¼, ~5ë¶„)
            # ì½”ë“œ(.py)ë§Œ ë°”ë€Œë©´ â†’ ì»¨í…Œì´ë„ˆ ìž¬ì‹œìž‘ë§Œ (ë¹ ë¦„, ~30ì´ˆ)
            if echo "$CHANGED" | grep -qE "requirements.txt|Dockerfile|docker-compose.yml"; then
              echo "ðŸ“¦ Dependency change detected â†’ Full rebuild..."
              docker compose up -d --build
              docker image prune -f
            else
              echo "ðŸ”„ Code-only change â†’ Fast restart..."
              docker restart daily-seongsu-container
            fi

            echo "âœ… Deployment Successful!"
          ENDSSH
